<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kullanıcı Paneli</title>
    <link rel="stylesheet" href="KullanıcıSayfa.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <script>
      if (!localStorage.getItem('userToken')) {
        alert('Bu sayfayı görüntülemek için lütfen giriş yapın.');
        window.location.href = 'Giriş.html';
      }
    </script>
  </head>

  <body class="bg-light-custom">
    <div style="font-size: 17px">
      <nav
        class="navbar navbar-expand-lg bg-light  position-relative py-2 font height:10vh shadow-sm "
      >
        <div class="container-fluid">
          <a class="navbar-brand" href="#">Kut-AI</a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarMain"
          >
            <span class="navbar-toggler-icon"></span>
          </button>


          <div class="d-flex gap-2 navbar-right">
            <div class="dropdown">
              <button class="btn btn-outline-primary dropdown-toggle rounded-5 px-3 " type="button" id="dropdownMenuButton" data-bs-toggle="dropdown">
                <i class="bi bi-person-circle me-1"  style="z-index: +1;"></i>Gözde Gönül
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#">Profil</a></li>
                <li><a class="dropdown-item" href="#">Ayarlar</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="index.html">Çıkış Yap</a></li>
              </ul>
            </div>
          </div>
        </div>
      </nav>
    </div>

    <div class="container-fluid py-4">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-3 d-none d-lg-block">
          <div class="card shadow-sm rounded-3 border-0 mb-4">
            <div class="card-body text-center py-4">
              <h5 class="mb-1">Gözde Gönül</h5>
              <p class="text-muted small">gozde.gonul@example.com</p>
              <div class="d-flex justify-content-center gap-2 mt-3">
                <span class="badge bg-success">Aktif</span>
              </div>
            </div>
          </div>
          
          <div class="card shadow-sm rounded-3 border-0">
            <div class="card-body">
              <h6 class="fw-bold mb-3">Psikolojik Durum Analizi</h6>
              <div class="progress mb-2" style="height: 8px;">
                <div class="progress-bar bg-danger" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <p class="small text-muted mb-3">Dışadönüklük: %25</p>
              
              <div class="progress mb-2" style="height: 8px;">
                <div class="progress-bar bg-warning" role="progressbar" style="width: 50%;" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <p class="small text-muted mb-3">Uyumluluk: %50</p>
              
              <div class="progress mb-2" style="height: 8px;">
                <div class="progress-bar bg-info" role="progressbar" style="width: 75%;" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <p class="small text-muted mb-3">Sorumluluk: %75</p>
              
              <div class="progress mb-2" style="height: 8px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: 60%;" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <p class="small text-muted">Duygusal Denge: %60</p>
            </div>
          </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-lg-9">
          <div class="card shadow-sm rounded-3 border-0 mb-4">
            <div class="card-body p-0">
              <ul class="nav nav-tabs" id="userTabs" role="tablist">
                  <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="oyun-tab" data-bs-toggle="tab" data-bs-target="#oyun" type="button" role="tab">Oyun</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link " id="anketler-tab" data-bs-toggle="tab" data-bs-target="#anketler" type="button" role="tab">Anketler</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="raporlar-tab" data-bs-toggle="tab" data-bs-target="#raporlar" type="button" role="tab">Raporlar</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="analizler-tab" data-bs-toggle="tab" data-bs-target="#analizler" type="button" role="tab">Analizler</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="mesajlar-tab" data-bs-toggle="tab" data-bs-target="#mesajlar" type="button" role="tab">Mesajlar</button>
                </li>
                   <button class="nav-link" id="randevu-tab" data-bs-toggle="tab" data-bs-target="#randevu" type="button" role="tab">Gelecek Randevularım</button>
                </li>
              </ul>

              
  

              
              <div class="tab-content p-4" id="userTabsContent">
                  <div class="tab-pane fade show active" id="oyun" role="tabpanel">
                    <section id="mainpage" class="video">
      <video autoplay="" muted="" loop="" playsinline="" class="bg-video">
        <source src="video.mp4" type="video/mp4" />
      </video>
      <a
        class="btn btn-danger rounded-5 px-3"
        href="#"
        id="btnoyna"
        style="z-index: +1"
        >Oyun Oyna</a>
    </div>
      



            
                <div class="tab-pane fade show" id="anketler" role="tabpanel">
                  <h4 class="mb-4">Mevcut Anketler</h4>
                  
                  <div class="row">
                    <div class="col-md-6 mb-4">
                      <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                          <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title mb-0">Depresyon Tarama Testi</h5>
                            <span class="badge bg-success">Tamamlandı</span>
                          </div>
                          <p class="card-text text-muted small">Son tamamlanma: 15.06.2023</p>
                          <div class="progress mb-3" style="height: 6px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 100%;"></div>
                          </div>
                          <a href="#" class="btn btn-sm btn-outline-primary">Sonuçları Görüntüle</a>
                          <a href="#" class="btn btn-sm btn-outline-secondary ms-2">Testi Tekrarla</a>
                        </div>
                      </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                      <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                          <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title mb-0">Anksiyete Ölçeği</h5>
                            <span class="badge bg-warning text-dark">Devam Ediyor</span>
                          </div>
                          <p class="card-text text-muted small">Son güncelleme: 20.06.2023</p>
                          <div class="progress mb-3" style="height: 6px;">
                            <div class="progress-bar bg-warning" role="progressbar" style="width: 65%;"></div>
                          </div>
                          <a href="#" class="btn btn-sm btn-primary">Teste Devam Et</a>
                        </div>
                      </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                      <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                          <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title mb-0">Kişilik Envanteri</h5>
                            <span class="badge bg-danger">Başlanmadı</span>
                          </div>
                          <p class="card-text text-muted small">Son erişim: Hiç</p>
                          <div class="progress mb-3" style="height: 6px;">
                            <div class="progress-bar bg-danger" role="progressbar" style="width: 0%;"></div>
                          </div>
                          <a href="#" class="btn btn-sm btn-danger">Teste Başla</a>
                        </div>
                      </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                      <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                          <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title mb-0">Stres Düzeyi Testi</h5>
                            <span class="badge bg-success">Tamamlandı</span>
                          </div>
                          <p class="card-text text-muted small">Son tamamlanma: 10.06.2023</p>
                          <div class="progress mb-3" style="height: 6px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 100%;"></div>
                          </div>
                          <a href="#" class="btn btn-sm btn-outline-primary">Sonuçları Görüntüle</a>
                          <a href="#" class="btn btn-sm btn-outline-secondary ms-2">Testi Tekrarla</a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Raporlar Tab -->
                <div class="tab-pane fade" id="raporlar" role="tabpanel">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="mb-0">Raporlarım</h4>
                    <button class="btn btn-sm btn-outline-primary">
                      <i class="bi bi-download"></i> Tümünü İndir
                    </button>
                  </div>
                  
                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead>
                        <tr>
                          <th>Rapor Adı</th>
                          <th>Oluşturulma Tarihi</th>
                  
                          <th>İşlemler</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>Psikolojik Değerlendirme Raporu</td>
                          <td>15.06.2023</td>
                         
                         
                          <td>
                            <button class="btn btn-sm btn-outline-primary">Görüntüle</button>
                            <button class="btn btn-sm btn-outline-danger">İndir</button>
                          </td>
                        </tr>
                        <tr>
                          <td>Terapi Süreci Değerlendirmesi</td>
                          <td>10.06.2023</td>
                     
                     
                          <td>
                            <button class="btn btn-sm btn-outline-primary">Görüntüle</button>
                            <button class="btn btn-sm btn-outline-danger">İndir</button>
                          </td>
                        </tr>
                        <tr>
                          <td>İlk Görüşme Notları</td>
                          <td>05.06.2023</td>
                     
                       
                          <td>
                            <button class="btn btn-sm btn-outline-primary" disabled>Görüntüle</button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
                
                <!-- Analizler Tab -->
                <div class="tab-pane fade" id="analizler" role="tabpanel">
                  <h4 class="mb-4">Psikolojik Analizlerim</h4>
                  
                  <div class="row">
                    <div class="col-md-6 mb-4">
                      <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                          <h5 class="card-title">Duygu Durum Analizi</h5>
                         
                          <p class="card-text mt-3 small">Son 30 gündeki duygu durum değişimleriniz.</p>
                          <a href="#" class="btn btn-sm btn-outline-primary">Detaylı İncele</a>
                        </div>
                      </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                      <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                          <h5 class="card-title">Stres Seviyesi Takibi</h5>
                          <div class="chart-container" style="height: 200px;">
                            <!-- Buraya bir grafik eklenecek -->
                          
                          </div>
                          <p class="card-text mt-3 small">Haftalık stres seviyenizin değişimi.</p>
                          <a href="#" class="btn btn-sm btn-outline-primary">Detaylı İncele</a>
                        </div>
                      </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                      <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                          <h5 class="card-title">Kişilik Özellikleri</h5>
                          <div class="chart-container" style="height: 200px;">
                            <!-- Buraya bir grafik eklenecek -->
                          
                          </div>
                          <p class="card-text mt-3 small">Big Five kişilik özelliklerinizin dağılımı.</p>
                          <a href="#" class="btn btn-sm btn-outline-primary">Detaylı İncele</a>
                        </div>
                      </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                      <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                          <h5 class="card-title">Uyku Kalitesi Analizi</h5>
                          <div class="chart-container" style="height: 200px;">
                            <!-- Buraya bir grafik eklenecek -->
                       
                          </div>
                          <p class="card-text mt-3 small">Aylık uyku kalitenizin değişimi.</p>
                          <a href="#" class="btn btn-sm btn-outline-primary">Detaylı İncele</a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Mesajlar Tab -->
                <div class="tab-pane fade" id="mesajlar" role="tabpanel">
                  <div class="row">
                    <div class="col-md-4">
                      <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-white border-0">
                          <h5 class="mb-0">Doktorlarım</h5>
                        </div>
                        <div class="card-body p-0">
                          <div class="list-group list-group-flush">
                            <a href="#" class="list-group-item list-group-item-action active">
                              <div class="d-flex align-items-center">
                            
                                <div>
                                  <h6 class="mb-0">Dr. Ayşe Demir</h6>
                                  <small class="text-white-50">Son mesaj: 15 dk önce</small>
                                </div>
                              </div>
                            </a>
                            <a href="#" class="list-group-item list-group-item-action">
                              <div class="d-flex align-items-center">
                      
                                <div>
                                  <h6 class="mb-0">Dr. Mehmet Kaya</h6>
                                  <small class="text-muted">Son mesaj: 2 gün önce</small>
                                </div>
                              </div>
                            </a>
                            <a href="#" class="list-group-item list-group-item-action">
                              <div class="d-flex align-items-center">
                               
                                <div>
                                  <h6 class="mb-0">Dr. Zeynep Akın</h6>
                                  <small class="text-muted">Son mesaj: 1 hafta önce</small>
                                </div>
                              </div>
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="col-md-8">
                      <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                          <div class="d-flex align-items-center">
                    
                            <div>
                              <h5 class="mb-0">Dr. Ayşe Demir</h5>
                              <small class="text-muted">Çevrimiçi</small>
                            </div>
                          </div>
                          <div>
                            <button class="btn btn-sm btn-outline-secondary">
                              <i class="bi bi-telephone"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary ms-2">
                              <i class="bi bi-three-dots-vertical"></i>
                            </button>
                          </div>
                        </div>
                        
                        <div class="card-body chat-messages" style="height: 400px; overflow-y: auto;">
                          <div class="message received mb-3">
                            <div class="message-content bg-light p-3 rounded">
                              <p class="mb-0">Merhaba Ahmet Bey, son test sonuçlarınızı inceledim. Görüşmek üzere randevu alabilir misiniz?</p>
                              <small class="text-muted d-block text-end mt-1">15:32 - 15.06.2023</small>
                            </div>
                          </div>
                          
                          <div class="message sent mb-3">
                            <div class="message-content bg-primary text-white p-3 rounded">
                              <p class="mb-0">Merhaba Doktor Hanım, randevu almayı düşünüyorum. Yarın saat 14:00 uygun mudur?</p>
                              <small class="text-white-50 d-block text-end mt-1">15:35 - 15.06.2023</small>
                            </div>
                          </div>
                          
                          <div class="message received mb-3">
                            <div class="message-content bg-light p-3 rounded">
                              <p class="mb-0">Yarın 14:00 uygun. Randevunuzu oluşturdum. Görüşmek üzere, kendinize iyi bakın.</p>
                              <small class="text-muted d-block text-end mt-1">15:37 - 15.06.2023</small>
                            </div>
                          </div>
                        </div>
                        
                        <div class="card-footer bg-white border-0">
                          <div class="input-group">
                            <input type="text" class="form-control rounded-start" placeholder="Mesaj yazın...">
                            <button class="btn btn-primary rounded-end" type="button">
                              <i class="bi bi-send"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
    
                </div>

                 <div class="tab-pane fade" id="randevu" role="tabpanel">
                  <div class="row">
                    <div class="col-md-12">
                      <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-white border-0">
                          <h5 class="mb-0">Gelecek Randevularım</h5>
                        </div>
                             <div class="card-body">
                            <div class="table-responsive">
                              <table class="table table-hover" id="upcomingAppointments">
                                <thead>
                                  <tr>
                                    <th>Tarih</th>
                                    <th>Saat</th>
                                    <th>Hasta</th>
                                    <th>Durum</th>
                                    <th>İşlemler</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <!-- JavaScript ile doldurulacak -->
                                </tbody>
                              </table>
                            </div>
                          </div>
                        </div>
<button id="raporBtn">Raporu Al</button>
<a id="pdfLink" href="#" target="_blank" style="display:none;">PDF Raporunu Görüntüle</a>
                
            </div>
          </div>
        </div>
      </div>
    </div>


    <script>
      document.addEventListener('DOMContentLoaded', function() {
          
          // ==========================================================
          // ÇIKIŞ YAPMA İŞLEVSELLİĞİ
          // ==========================================================
          const logoutLink = document.getElementById('logout-link');
          if (logoutLink) {
              logoutLink.addEventListener('click', function(event) {
                  event.preventDefault();
                  
                  // Tarayıcıdan kullanıcı oturum bilgilerini temizle
                  localStorage.removeItem('userToken');
                  localStorage.removeItem('userId');
                  localStorage.removeItem('username'); // veya userEmail
                  
                  alert('Başarıyla çıkış yaptınız.');
                  window.location.href = 'index.html'; // Ana sayfaya yönlendir
              });
          }
      
          // ==========================================================
          // OYUN OYNAMA BUTONU İŞLEVSELLİĞİ
          // ==========================================================
          const oynaButonu = document.getElementById('btnoyna');
          if (oynaButonu) {
              // Tarayıcıdan giriş yapmış kullanıcının ID'sini al
              const loggedInUserId = localStorage.getItem('userId');
              
              if (loggedInUserId) {
                  // Butonun linkini kullanıcının ID'si ile güncelle
                  const oyunLinki = 'https://ardaarslan.com.tr/oyun/';
                  oynaButonu.href = oyunLinki + '?userId=' + loggedInUserId;
                  // Yeni sekmede açılması için target attribute'u da ekleyelim
                  oynaButonu.setAttribute('target', '_blank');
              } else {
                  // Eğer bir şekilde ID alınamazsa, butonu gizle ve hata ver
                  oynaButonu.style.display = 'none';
                  console.error("Oyun başlatılamadı: Giriş yapmış kullanıcı ID'si bulunamadı.");
              }
          }
      
          // ==========================================================
          // RAPORU ALMA İŞLEVSELLİĞİ
          // ==========================================================
          const raporButonu = document.getElementById('raporBtn');
          if (raporButonu) {
              raporButonu.addEventListener('click', async () => {
                  // Tarayıcıdan o an giriş yapmış olan kullanıcının ID'sini al
                  const currentUserId = localStorage.getItem('userId');
      
                  if (!currentUserId) {
                      alert("Raporu almak için giriş yapmış olmalısınız.");
                      return;
                  }
      
                  raporButonu.disabled = true;
                  raporButonu.innerText = 'Rapor Oluşturuluyor...';
                  
                  try {
                      // Kendi N8N webhook URL'nizi buraya yazın
                      const response = await fetch("http://192.168.1.152:5678/webhook/oyun", {
                          method: "POST",
                          headers: { "Content-Type": "application/json" },
                          // Sabit ID yerine, giriş yapan kullanıcının ID'sini gönder
                          body: JSON.stringify({ userId: currentUserId }) 
                      });
      
                      if (!response.ok) {
                          throw new Error(`Sunucu Hatası: ${response.status}`);
                      }
                      
                      const data = await response.json();
      
                      // 1. PDF Linkini Güncelle
                      if (data.pdfLink) {
                          const pdfLinkElement = document.getElementById('pdfLink');
                          pdfLinkElement.href = data.pdfLink;
                          pdfLinkElement.style.display = 'inline-block';
                      }
      
                      // 2. Psikolojik Durum Grafiğini Güncelle
                      if (data.scores) {
                          updatePsychologyChart(data.scores);
                      }
      
                  } catch (error) {
                      console.error("Rapor alma işlemi sırasında bir hata oluştu:", error);
                      alert("Rapor alınırken bir hata oluştu. Lütfen daha sonra tekrar deneyin.");
                  } finally {
                      raporButonu.disabled = false;
                      raporButonu.innerText = 'Raporu Al';
                  }
              });
          }
      
          // ==========================================================
          // GRAFİK GÜNCELLEME FONKSİYONU
          // ==========================================================
          function updatePsychologyChart(scores) {
              // Her bir özellik için ID'leri ve skorları eşleştirerek güncelle
              const chartMapping = {
                  disadonukluk: { barId: 'bar-disadonukluk', textId: 'text-disadonukluk', label: 'Dışadönüklük' },
                  uyumluluk: { barId: 'bar-uyumluluk', textId: 'text-uyumluluk', label: 'Uyumluluk' },
                  sorumluluk: { barId: 'bar-sorumluluk', textId: 'text-sorumluluk', label: 'Sorumluluk' },
                  duygusalDenge: { barId: 'bar-duygusaldenge', textId: 'text-duygusaldenge', label: 'Duygusal Denge' }
                  // Deneyime açıklık vb. eklenecekse buraya ekleyin
              };
      
              for (const key in scores) {
                  if (chartMapping[key]) {
                      const mapping = chartMapping[key];
                      const score = scores[key];
                      
                      const barElement = document.getElementById(mapping.barId);
                      const textElement = document.getElementById(mapping.textId);
      
                      if (barElement && textElement) {
                          barElement.style.width = score + '%';
                          barElement.setAttribute('aria-valuenow', score);
                          textElement.innerText = `${mapping.label}: %${score}`;
                      }
                  }
              }
          }
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
